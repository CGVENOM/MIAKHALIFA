name: Auto Restart and Keep Codespace Active

on:
  schedule:
    - cron: '* * * * *'  # Runs every minute
  workflow_dispatch:

jobs:
  restart_codespace:
    runs-on: ubuntu-latest

    steps:
      - name: Install GitHub CLI if not present
        run: |
          if ! command -v gh &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y gh jq
          fi

      - name: Authenticate GitHub CLI with Personal Access Token
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Use the token stored in GitHub Secrets
        run: |
          echo "${GITHUB_TOKEN}" | gh auth login --with-token
          echo "Authenticated GitHub CLI successfully."

      - name: Check Codespace Status and Keep Alive
        run: |
          CODESPACE_NAME="ubiquitous-umbrella-76v694w6q6rhw6w5"
          STATUS=$(gh codespace list --json name,state | jq -r --arg name "$CODESPACE_NAME" '.[] | select(.name == $name) | .state')

          if [ -z "$STATUS" ]; then
            echo "Error: Unable to fetch codespace status or codespace does not exist."
            exit 1
          fi

          echo "Codespace status: $STATUS"

          if [ "$STATUS" == "Shutdown" ]; then
            echo "Codespace is offline. Attempting to start it by SSH..."
            if gh codespace ssh --codespace $CODESPACE_NAME -- echo 'Codespace started!'; then
              echo "Codespace successfully started."
            else
              echo "Error: Failed to start the Codespace."
              exit 1
            fi
          else
            echo "Codespace is active. Sending keep-alive signal..."
            if gh codespace ssh --codespace $CODESPACE_NAME -- echo 'Keep-alive signal'; then
              echo "Keep-alive signal sent successfully."
            else
              echo "Error: Failed to send keep-alive signal."
              exit 1
            fi
          fi
